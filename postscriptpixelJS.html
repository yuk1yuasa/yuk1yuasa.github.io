<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"/>
<title>Pixel art to PostScript</title>
<style>
canvas{border: 1px solid black;padding: 0;display: block;}
button{padding:15px 30px;background-color:#fffb24;border-raduis:10px;}
</style>
</head>
<body onkeydown="move(event)" onmouseup="mouseisdown=false">
<canvas id="canvas" width=300 height=300 onmousedown="mousedown(event)" onmouseup="changelog.push('s,'+mousedownaction.join('/'));mousedownaction=[];clik(event)" onmousemove="mousemove(event)"></canvas>
canvas width:<input id="width" type="number" value=300 onchange="draw()"></input>
 height:<input id="height" type="number" value=300 onchange="draw()"></input><br><br>
pixel width:<input id="pxwidth" type="number" value=30 min=1 onchange="draw()"></input>
 height:<input id="pxheight" type="number" value=30 min=1 onchange="draw()"></input><br>
<select name="tools" id="tools">
 <option value="pixel">Pixel</option>
 <option value="eraser">Eraser</option>
<br><input id='color' type='color'></input>
<button id="grid" onclick="showhidegrid()">Show grid</button><button id="undo" onclick="undo()">undo</button><button id="redo" onclick="redo()">redo</button>
 <button id="st" onclick="clearcanvas()">clear</button><button id="slbutton" onclick="var prom=prompt('Type in s for save, l for load');if(prom=='s'||prom=='S'){save()}else if(prom=='l'||prom=='L'){load()}">Save/load</button>
<br><br><br>
<button type="button" onclick="pixel2ps()" style="border:none;">Make it PostScript!</button><br>
<textarea id="ps"></textarea><br><br>

Try your postscript hereâ†“<br>
<iframe src='https://ehubsoft.herokuapp.com/psviewer/?authuser=0' title='PostScript compiler' width=700 height=400></iframe>
<p>Examples of PostScript pixel art:</p><a href='../postscriptgallery.html'>https://yuk1yuasa.github.io/postscriptgallery.html</a>
<script>
/**format for most things
1st level combine:, 2nd level:/ 3rd level:&
adding pixel:a,x,y,rgb
overwrting pixel:c,i,rgbold,rgbnew
erasing:e,i,x,y,rgbold
clearing:x,pixelx,pixely,pixelrgb
**/
let canvas = document.getElementById("canvas");
let ctx = canvas.getContext("2d");
var pixelx = [];var pixely=[];var pixelrgb=[];
var pxx='';var pxy='';var pxr='';var pxg='';var pxb='';
var showgrid = false;
var changelog=[];
var undolog=[];
var mousepos=[];var mouseisdown=false;var mousedownaction=[];
draw()

function move(event){
 switch(event.key){
  case "u":
   undo();
   break;
  case "r":
   redo();
   break;
  case "g":
   showhidegrid();
   break;
 }
}

function mousedown(event){
 mousepos=[event.offsetX, event.offsetY];mouseisdown=true;
}

function mousemove(event){
 if(mouseisdown){clik(event)};
}
 
function clik(event){
 var x = Math.floor(event.offsetX/gete('pxwidth').value);
 var y = Math.floor((canvas.height-event.offsetY)/gete('pxheight').value);
 if(gete("tools").value=="eraser"){//erase
  for(i=0;i<pixelx.length;i++){
   if(pixelx[i]==x&&pixely[i]==y){if(!mouseisdown){changelog.push(`e,${i},${x},${y},${pixelrgb[i]}`);}else{mousedownaction.push(`e,${i},${x},${y},${pixelrgb[i]}`);}
   pixelx.splice(i,1);pixely.splice(i,1);pixelrgb.splice(i,1);draw();return;}
  };draw();return;
 };
 var rgb = gete('color').value;
 undolog=[];
 for(i=0;i<pixelx.length;i++){//overwrite
  if(pixelx[i]==x&&pixely[i]==y){if(pixelrgb[i]==rgb){return};changelog.push(`c,${i},${pixelrgb[i]},${rgb}`);pixelrgb[i]=rgb;draw();return;}
 }
 pixelx.push(x);pixely.push(y);pixelrgb.push(rgb);changelog.push(`a,${x},${y},${rgb}`);
 draw()
}

function draw(){
canvas.width=document.getElementById("width").value
canvas.height=document.getElementById('height').value
ctx.setTransform(1, 0, 0, -1, 0, canvas.height);
var w = gete('pxwidth').value;var h = gete('pxheight').value;
if(showgrid){//show grid
 var strokestyle=ctx.strokeStyle;
 ctx.strokeStyle='black';
 for(var i=1;i<=Math.floor(canvas.width/w);i++){//vertical lines
  ctx.moveTo(w*i, 0);
  ctx.lineTo(w*i, canvas.height);
 }
 for(var j=1;j<=Math.floor(canvas.height/h);j++){//horizontal lines
  ctx.moveTo(0, h*j);
  ctx.lineTo(canvas.width, h*j);
 }
 ctx.stroke();
 ctx.strokeStyle=strokestyle;
}
for(var i=0;i<pixelx.length;i++){//draw pixels
    ctx.fillStyle=pixelrgb[i];
    ctx.fillRect(pixelx[i]*w, pixely[i]*h, w, h);
}
}
 
function pixel2ps(){
    pxx='['+pixelx.join(" ")+']'

    pxy='['+pixely.join(" ")+']'
    
    pxr='['
    for(var i=0; i<pixelrgb.length;i++){
        pxr=pxr+Number('0x'+pixelrgb[i].slice(1, 3))/255+' '
    }
    pxr=pxr+']'
    
    pxg='['
    for(var i=0; i<pixelrgb.length;i++){
        pxg=pxg+Number('0x'+pixelrgb[i].slice(3, 5))/255+' '
    }
    pxg=pxg+']'
    
    pxb='['
    for(var i=0; i<pixelrgb.length;i++){
        pxb=pxb+Number('0x'+pixelrgb[i].slice(5, 7))/255+' '
    }
    pxb=pxb+']'

    var str=`%!PS-Adobe-3.0

/xpx ${canvas.width} def 
/ypx ${canvas.height} def 
%specify x and y pdf size
/x ${document.getElementById('pxwidth').value} def 
/y ${document.getElementById('pxheight').value} def
%specify x and y pixel size(NOT pixel number)

<< /PageSize [xpx ypx]>> setpagedevice

/xcoord ${pxx} def 
/ycoord ${pxy} def
/r ${pxr} def
/g ${pxg} def
/b ${pxb} def

0 1 xcoord length 1 sub {dup
dup dup r exch get exch dup g exch get exch b exch get setrgbcolor
newpath
dup dup xcoord exch get x mul exch ycoord exch get y mul moveto
dup dup xcoord exch get x mul x add exch ycoord exch get y mul lineto
dup dup xcoord exch get x mul x add exch ycoord exch get y mul y add lineto
dup dup xcoord exch get x mul exch ycoord exch get y mul y add lineto
closepath
fill
} for

showpage`
    document.getElementById('ps').value=str
}

function showhidegrid(){
 var grid=gete('grid');
 if(!showgrid){
  showgrid=true;
  grid.innerHTML='Hide grid';
 }else{
  showgrid=false;
  grid.innerHTML='Show grid';
 }
 draw();
}
 
function undo(){
 if(changelog.length<1){return;}
 var lastchange=changelog[changelog.length-1].split(",");
 undoaction(changelog[changelog.length-1].split(","));
 undolog.push(changelog.pop());
 draw()
}

function undoaction(a){
 switch(a[0]){
  case "a"://undo add
   pixelx.pop()
   pixely.pop()
   pixelrgb.pop()
   break;
  case "c"://undo change color
   pixelrgb[a[1]]=a[2]
   break;
  case "e"://undo erase
   pixelx.splice(a[1], 0, a[2]);pixely.splice(a[1], 0, a[3]);pixelrgb.splice(a[1], 0, a[4]);
   break;
  case "s"://undo series
   var b=a.splice(0, 1).join(",").split("/")
   for(var x of b){undoaction(x)}
   break;
  case "x"://undo clear
   pixelx=a[1].split("/");pixely=a[2].split("/");pixelrgb=a[3].split("/");
   break;
 }
}

function redo(){
 if(undolog.length<1){return;}
 if(typeof undolog[undolog.length-1]=='object'){for(var i=0;i<undolog[undolog.length-1].length;i++){}};
 var lastundo=undolog[undolog.length-1].split(",");
 switch(lastundo[0]){
  case "a"://redo add
   pixelx.push(lastundo[1]);pixely.push(lastundo[2]);pixelrgb.push(lastundo[3]);
   break;
  case "c"://redo change color
   pixelrgb[lastundo[1]]=lastundo[3];
   break;
  case "x"://redo clear
   pixelx = [];pixely=[];pixelrgb=[];
   pxx='';pxy='';pxr='';pxg='';pxb='';
   break;
  case "e"://redo erasing
   pixelx.splice(lastundo[1],1);pixely.splice(lastundo[1],1);pixelrgb.splice(lastundo[1],1);
   break;
 }
 changelog.push(undolog.pop());
 draw();
}

function save(){
 localStorage.setItem("saveddata", `${pixelx.join("/")},${pixely.join("/")},${pixelrgb.join("/")}`);
 localStorage.setItem("changelog", `${changelog.join("&")}`);
 localStorage.setItem("undolog", `${undolog.join("&")}`);
 alert('PostScript saved');
}

function load(){
 if(typeof localStorage.getItem("saveddata")!='string'){alert('No data stored');return}
 var localdata=localStorage.getItem("saveddata").split(",");
 if(!confirm('This will overwrite the existing drawing. Continue?')){return}
 pixelx=localdata[0].split("/");
 pixely=localdata[1].split("/");
 pixelrgb=localdata[2].split("/");
 changelog=geti("changelog").split("&");
 undolog=geti("undolog").split("&");
 alert('Loaded on')
 draw();
}
 
function clearcanvas(){
if(pixelx.length<1){return;}
//add to changelog
changelog.push(`x,${pixelx.join("/")},${pixely.join("/")},${pixelrgb.join("/")}`)
//erase afterwards
pixelx = [];pixely=[];pixelrgb=[];
pxx='';pxy='';pxr='';pxg='';pxb='';
draw()
}

function gete(str){
return document.getElementById(str);
}

function geti(str){
return localStorage.getItem(str);
}
</script>
</body>
</html>
