<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"/>
<title>Pixel art to PostScript</title>
<style>
canvas{border: 1px solid black;padding: 0;display: block;}
button{padding:15px 30px;}
</style>
</head>
<body onkeydown="move(event)">
<canvas id="canvas" width=300 height=300 onclick="clik(event)"></canvas>
canvas width:<input id="width" type="number" value=300 onchange="draw()"></input>
 height:<input id="height" type="number" value=300 onchange="draw()"></input><br><br>
pixel width:<input id="pxwidth" type="number" value=30 onchange="draw()"></input>
 height:<input id="pxheight" type="number" value=30 onchange="draw()"></input><br>
<br><input id='color' type='color'></input>
<button id="grid" onclick="showhidegrid()">Show grid</button><br>
<button id="st" onclick="undo()">undo</button><button id="st" onclick="clearcanvas()">clear</button>
<br><br><br>
<button type="button" onclick="pixel2ps()">Make it PostScript!</button><br>
<textarea id="ps"></textarea><br><br>

Try your postscript here:<br>
<iframe src='https://ehubsoft.herokuapp.com/psviewer/?authuser=0' title='PostScript compiler' width=700 height=400></iframe>
<script>
let canvas = document.getElementById("canvas");
let ctx = canvas.getContext("2d");
var pixelx = [];var pixely=[]; var pixelr=[]; var pixelg=[]; var pixelb=[];var pixelrgb=[];
pxx='';pxy='';pxr='';pxg='';pxb='';
var showgrid = False;

ctx.transform(1, 0, 0, -1, 0, canvas.height);

function clik(event){
var x = Math.floor(event.offsetX/gete('pxwidth').value);
var y = Math.floor((canvas.height-event.offsetY)/gete('pxheight').value);
pixelx.push(x);pixely.push(y);pixelrgb.push(gete('color').value);pixelr.push(Number('0x'+gete('color').value.slice(1, 3))/255);pixelg.push(Number('0x'+gete('color').value.slice(3, 5))/255);pixelb.push(Number('0x'+gete('color').value.slice(5, 7))/255);
draw()
}

function draw(){
canvas.width=document.getElementById("width").value
canvas.height=document.getElementById('height').value
var w = gete('pxwidth').value;var h = gete('pxheight').value;
if(showgrid){
 var strokestyle=ctx.strokeStyle;
 ctx.strokeStyle='black';
 for(var i=1;i<=Math.floor(canvas.width/w);i++){
  ctx.moveTo(w*i, 0);
  ctx.lineTo(w*i, canvas.height);
 }
 for(var j=1;j<=Math.floor(canvas.height/h);j++){
  ctx.moveTo(0, h*j);
  ctx.lineTo(canvas.width, h*j);
 }
 ctx.stroke();
 ctx.strokeStyle=strokestyle;
}
for(var i=0;i<pixelx.length;i++){
    ctx.fillStyle=pixelrgb[i];
    ctx.fillRect(pixelx[i]*w, pixely[i]*h, w, h);
}
}

function pixel2ps(){
    pxx='['
    for(var i=0; i<pixelx.length-1;i++){
        pxx=pxx+pixelx[i]+' '
    }
    pxx=pxx+pixelx[pixelx.length-1]+']'

    pxy='['
    for(var i=0; i<pixely.length-1;i++){
        pxy=pxy+pixely[i]+' '
    }
    pxy=pxy+pixely[pixely.length-1]+']'
    
    pxr='['
    for(var i=0; i<pixelr.length-1;i++){
        pxr=pxr+pixelr[i]+' '
    }
    pxr=pxr+pixelr[pixelr.length-1]+']'
    
    pxg='['
    for(var i=0; i<pixelg.length-1;i++){
        pxg=pxg+pixelg[i]+' '
    }
    pxg=pxg+pixelg[pixelg.length-1]+']'
    
    pxb='['
    for(var i=0; i<pixelb.length-1;i++){
        pxb=pxb+pixelb[i]+' '
    }
    pxb=pxb+pixelb[pixelb.length-1]+']'

    var str=`%!PS-Adobe-3.0

/xpx ${canvas.width} def 
/ypx ${canvas.height} def 
%specify x and y pdf size
/x ${document.getElementById('pxwidth').value} def 
/y ${document.getElementById('pxheight').value} def
%specify x and y pixel size(NOT pixel number)

<< /PageSize [xpx ypx]>> setpagedevice

/xcoord ${pxx} def 
/ycoord ${pxy} def
/r ${pxr} def
/g ${pxg} def
/b ${pxb} def

0 1 xcoord length 1 sub {dup
dup dup r exch get exch dup g exch get exch b exch get setrgbcolor
newpath
dup dup xcoord exch get x mul exch ycoord exch get y mul moveto
dup dup xcoord exch get x mul x add exch ycoord exch get y mul lineto
dup dup xcoord exch get x mul x add exch ycoord exch get y mul y add lineto
dup dup xcoord exch get x mul exch ycoord exch get y mul y add lineto
closepath
fill
} for

showpage`
    document.getElementById('ps').value=str
}

function showhidegrid(){
 var grid=gete('grid');
 if(!showgrid){
  showgrid=True;
  grid.innerHTML='Hide grid';
 }else{
  showgrid=False;
  grid.innerHTML='Show grid';
 }
 draw();
}
 
function undo(){
 if(pixelx.length>0){
  pixelx.pop()
  pixely.pop()
 }
 draw()
}
 
function clearcanvas(){
pixelx = [];pixely=[];pixelr=[];pixelg=[];pixelb=[];pixelrgb=[];
pxx='';pxy='';pxr='';pxg='';pxb='';
draw()
}

function gete(str){
return document.getElementById(str)
}
</script>
</body>
</html>
