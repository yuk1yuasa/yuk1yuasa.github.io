<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"/>
<title>Pixel art to PostScript</title>
<style>
canvas{border: 1px solid black;padding: 0;display: block;}
button{padding:15px 30px;background-color:#fffb24;}
</style>
</head>
<body onkeydown="move(event)">
<canvas id="canvas" width=300 height=300 onclick="clik(event)"></canvas>
canvas width:<input id="width" type="number" value=300 onchange="draw()"></input>
 height:<input id="height" type="number" value=300 onchange="draw()"></input><br><br>
pixel width:<input id="pxwidth" type="number" value=30 onchange="draw()"></input>
 height:<input id="pxheight" type="number" value=30 onchange="draw()"></input><br>
<br><input id='color' type='color'></input>
<button id="grid" onclick="showhidegrid()">Show grid</button><button id="st" onclick="undo()">undo</button><button id="st" onclick="clearcanvas()">clear</button>
<br><br><br>
<button type="button" onclick="pixel2ps()">Make it PostScript!</button><br>
<textarea id="ps"></textarea><br><br>

Try your postscript hereâ†“<br>
<iframe src='https://ehubsoft.herokuapp.com/psviewer/?authuser=0' title='PostScript compiler' width=700 height=400></iframe>
<p>Examples of PostScript pixel art:</p><a href='../postscriptgallery.html'>https://yuk1yuasa.github.io/postscriptgallery.html</a>
<script>
let canvas = document.getElementById("canvas");
let ctx = canvas.getContext("2d");
var pixelx = [];var pixely=[];var pixelrgb=[];
var pxx='';var pxy='';var pxr='';var pxg='';var pxb='';
var showgrid = false;
var changelog=[];
var undolog=[];
draw()

function clik(event){
 var x = Math.floor(event.offsetX/gete('pxwidth').value);
 var y = Math.floor((canvas.height-event.offsetY)/gete('pxheight').value);
 var rgb = gete('color').value;
 undolog=[];
 for(i=0;i<pixelx.length;i++){//overwrite
  if(pixelx[i]==x&&pixely[i]==y){changelog.push(`c,${i},${pixelrgb[i]},${rgb}`);pixelrgb[i]=rgb;draw();return;}
 }
 pixelx.push(x);pixely.push(y);pixelrgb.push(rgb);changelog.push(`a,${x},${y},${rgb}`);
 draw()
}

function draw(){
canvas.width=document.getElementById("width").value
canvas.height=document.getElementById('height').value
ctx.setTransform(1, 0, 0, -1, 0, canvas.height);
var w = gete('pxwidth').value;var h = gete('pxheight').value;
if(showgrid){//show grid
 var strokestyle=ctx.strokeStyle;
 ctx.strokeStyle='black';
 for(var i=1;i<=Math.floor(canvas.width/w);i++){//vertical lines
  ctx.moveTo(w*i, 0);
  ctx.lineTo(w*i, canvas.height);
 }
 for(var j=1;j<=Math.floor(canvas.height/h);j++){//horizontal lines
  ctx.moveTo(0, h*j);
  ctx.lineTo(canvas.width, h*j);
 }
 ctx.stroke();
 ctx.strokeStyle=strokestyle;
}
for(var i=0;i<pixelx.length;i++){//draw pixels
    ctx.fillStyle=pixelrgb[i];
    ctx.fillRect(pixelx[i]*w, pixely[i]*h, w, h);
}
}

function pixel2ps(){
    pxx='['+pixelx.join(" ")+']'

    pxy='['+pixely.join(" ")+']'
    
    pxr='['
    for(var i=0; i<pixelrgb.length;i++){
        pxr=pxr+Number('0x'+pixelrgb[i].slice(1, 3))/255+' '
    }
    pxr=pxr+']'
    
    pxg='['
    for(var i=0; i<pixelrgb.length;i++){
        pxg=pxg+Number('0x'+pixelrgb[i].slice(3, 5))/255+' '
    }
    pxg=pxg+']'
    
    pxb='['
    for(var i=0; i<pixelrgb.length;i++){
        pxb=pxb+Number('0x'+pixelrgb[i].slice(5, 7))/255+' '
    }
    pxb=pxb+']'

    var str=`%!PS-Adobe-3.0

/xpx ${canvas.width} def 
/ypx ${canvas.height} def 
%specify x and y pdf size
/x ${document.getElementById('pxwidth').value} def 
/y ${document.getElementById('pxheight').value} def
%specify x and y pixel size(NOT pixel number)

<< /PageSize [xpx ypx]>> setpagedevice

/xcoord ${pxx} def 
/ycoord ${pxy} def
/r ${pxr} def
/g ${pxg} def
/b ${pxb} def

0 1 xcoord length 1 sub {dup
dup dup r exch get exch dup g exch get exch b exch get setrgbcolor
newpath
dup dup xcoord exch get x mul exch ycoord exch get y mul moveto
dup dup xcoord exch get x mul x add exch ycoord exch get y mul lineto
dup dup xcoord exch get x mul x add exch ycoord exch get y mul y add lineto
dup dup xcoord exch get x mul exch ycoord exch get y mul y add lineto
closepath
fill
} for

showpage`
    document.getElementById('ps').value=str
}

function showhidegrid(){
 var grid=gete('grid');
 if(!showgrid){
  showgrid=true;
  grid.innerHTML='Hide grid';
 }else{
  showgrid=false;
  grid.innerHTML='Show grid';
 }
 draw();
}
 
function undo(){
 if(changelog.length<1){return;}
 var lastchange=changelog[changelog.length-1].split(",");
 switch(lastchange[0]){
  case "a"://undo add
   pixelx.pop()
   pixely.pop()
   pixelrgb.pop()
   break;
  case "c"://undo change color
   pixelrgb[lastchange[1]]=lastchange[2]
   break;
  case "x"://undo clear
   pixelx=lastchange[1].split("/");pixely=lastchange[2].split("/");pixelrgb=lastchange[3].split("/");
   break;
 }
 undolog.push(changelog.pop());
 draw()
}

function redo(){
 if(undolog.length<1){return;}
 var lastundo=undolog[undolog.length-1].split(",");
 switch(lastundo[0]){
  case "a"://redo add
   pixelx.push(lastundo[1]);pixely.push(lastundo[2]);pixelrgb.push(lastundo[3]);
   break;
  case "c"://redo change color
   pixelrgb[lastundo[1]]=lastundo[3];
   break;
  case "x"://redo clear
   clearcanvas();
   break;
 }
 changelog.push(undolog.pop());
 draw();
}
 
function clearcanvas(){
if(pixelx.length<1){return;}
//add to changelog
changelog.push(`x,${pixelx.join("/")},${pixely.join("/")},${pixelrgb.join("/")}`)
//erase afterwards
pixelx = [];pixely=[];pixelrgb=[];
pxx='';pxy='';pxr='';pxg='';pxb='';
draw()
}

function gete(str){
return document.getElementById(str)
}
</script>
</body>
</html>
